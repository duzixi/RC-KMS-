<html>
<head>
<title>RC-KMS_知识超网</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes"/>

<script src="js/Web.js"> </script>
<script src="js/XML.js"> </script>
<script src="js/RC-KMS.js"> </script>

<script src="js/echarts.js"></script>
<link rel="stylesheet" href="css/rc.css" />
<link rel="stylesheet" href="css/bootstrap.min.css" />
<script>

// 页面加载完成后呈现
function visual() {

    var myChart = echarts.init(document.getElementById('echart'));

    if (getParamOfURL("id") == false) {
        // CASE 1: 宏观知识网络
        myChart.setOption(macroOption());

        // 添加点击相应事件【未完待续】
        myChart.on('click', function (params) {
            console.log(params.data.id + " " + params.data.name);
        });
    } else {
        // CASE 2: 微观知识网络
        myChart.setOption(microOption());

        // 添加点击相应事件【未完待续】
        myChart.on('click', function (params) {
            // 点击转移网络中心
            if (params.dataType == "edge") {
                return;
            }
            console.log(params);
            turnConnection(params.data.id);
        });

    }   	
}

// 微观知识网略位置
function microOption() {
    var nodes = [];  // 存储所有节点
    var links = [];  // 存储所有边
    var categories = []; // 分类名与颜色 字典数组


    // STEP 1: 确定关注焦点（网络中心点）
    var elmId = getParamOfURL("id");
    var elmClass = dicBriefName[elmId.substring(0,1)]; // 知识要素类型英文名
    var xPath = "*[@id ='"+elmId+"']/name";
    var elmNameNode = elmXmls[elmClass].selectSingleNodeByXPath(xPath);
    
    var centerNode = {};
    centerNode.id = elmId;
    centerNode.name = elmNameNode.innerHTML;
    centerNode.category = elmClass;

    // STEP 2: 一层搜索
    search(centerNode, nodes, links);

    // STEP 3: 二层搜索
    var nodes2 = []; // 单独存，不然会死循环
    for(var i = 0; i < nodes.length; i++) {
        search(nodes[i], nodes2, links);
    }

    // STEP 4: 节点数组合并
    nodes.push(centerNode);
    nodes = nodes.concat(nodes2);

    // 以ID为基准去重
    var dicNodes = {}; // 字典法
    for (var i = 0; i < nodes.length; i++) {
        dicNodes[nodes[i].id] = nodes[i];
    }
    nodes = Object.values(dicNodes);


    nodes.forEach(function (node) {
        node.itemStyle = {};
        node.itemStyle.normal = {};
        node.x = node.y = null;
        node.draggable = true;
        // node.value = 0;
        // node.degree = 0;
        // nodeDic[node.id] = node;
    });

    // STEP 5: 可视化配置
    var option = {
        title: {
            text: '微观知识网络',
            subtext: "(" + centerNode.name + ")",
            top: 'top',
            left: 'left'
        },
        /*
        color: categories.map(function (a) {
            return a.color;
        }),*/
        /*
        legend: [
            {
                // selectedMode: 'single',
                data: categories.map(function (a) {
                    return a.name;
                }),
                left:'left',
                top: 'top'
            }
        ],
        */
        animation: false,
        series : [
            {
                name: '',
                type: 'graph',
                layout: 'force',
                data: nodes,
                links: links,
                label : {
                    position: 'right',
                    show: true,
                    formatter: function (p) { 
                        return p.name;
                    }
                },
                // focusNodeAdjacency: true,
                emphasis: {

                },
                categories: categories,
                roam: true,
                force: {
                    repulsion: 140
                }
            }
        ]
    };

    return option;

}

// 搜索知识网络关联节点
function search(node, nodes, links){

    // STEP 1: 正向关联搜索
    var xPath = "*[@id ='"+ node.id + "']/child::node()[@refer]";
    var referProps = elmXmls[node.category].selectNodesByXPath(xPath);
    if (referProps != null || referProps.length != 0) {
        for (var i = 0; i < referProps.length; i++) 
        {
            // STEP 0: 校验
            if (referProps[i] == null || referProps[i] == undefined) {
                continue;
            }

            var referString = referProps[i].getAttribute("refer");
            if (referString == "") {
                continue;
            }

            // STEP 1: 获取类别
            var referType = referProps[i].tagName;
            
            // STEP 2: 获取关联对象
            var referNodes = referString.split('#');
            for (var j = 0; j < referNodes.length; j++) {
                // STEP 2.1: 添加节点
                var referNode = {};
                referNode.id = referNodes[j].split('$')[1];
                referNode.name = referNodes[j].split('$')[0];
                referNode.category = dicBriefName[referNode.id.substring(0,1)];
                nodes.push(referNode);

                // STEP 2.2: 添加关联
                var link = {};
                link.id = node.id + "_" + referNode.id;
                link.source = node.id; // 正向关联
                link.target = referNode.id;
                link.category = referType;
                links.push(link);
            } 
        }
    }
    
    // STEP 2: 反向关联搜索
    // var xPath="//"+userElements[i]+"/*[contains(@refer,'"+id+"')]";
    xPath = "//*[contains(@refer,'" + node.id + "')]";
    for (var i = 0; i < elmNames.length; i++) {
        var xmlNodes = elmXmls[elmNames[i]].selectNodesByXPath(xPath);
        if (xmlNodes == null || xmlNodes.length == 0) {
            continue;
        }
        for (var j = 0; j < xmlNodes.length; j++) {
            if (xmlNodes[j] == null || xmlNodes[j].parentNode == null) {
                continue;
            }
            // STEP 2.1: 添加节点
            var referNode = {};
            referNode.id = xmlNodes[j].parentNode.getAttribute("id");
            var nodeClass = dicBriefName[referNode.id.substring(0,1)];    
            var xPath = "*[@id ='"+referNode.id+"']/name";
            var nameNode = elmXmls[nodeClass].selectSingleNodeByXPath(xPath);
            referNode.name = nameNode.innerHTML;
            referNode.category = nodeClass;
            nodes.push(referNode);

            // STEP 2.2: 添加关联
            var link = {};
            link.id = referNode.id + "_" + node.id;
            link.source = referNode.id; // 反向关联
            link.target = node.id;
            link.category = xmlNodes[j].tagName;
            links.push(link);
        }
    }
}

// 宏观知识网络配置
function macroOption() {
    var data = [];
    var links = [];
    for (var nodeName in elmInfos) {
        data[data.length] = elmInfos[nodeName].ToEChartData();
        links = links.concat(elmInfos[nodeName].ToEChartLinks());
    }

    // 跟据value 设置样式
    for (var i = 0; i < links.length; i++ ) {
        links[i].lineStyle = {
            normal : {
                color : 'source',
                width : Math.sqrt(links[i].value),
                curveness : (function() {  
                    var rate = 1;
                    if (links[i].source > links[i].target) {
                        rate = -1;
                    }
                    return 0.1 * rate;
                })()
            }
        };
    }

    // 指定图表的配置项和数据
    var option = {
        title: {
            text: '宏观知识网络'
        },
        tooltip: {},
        
        series: [{
            name: '知识要素类型',
            type: 'graph',
            layout: 'circular',
            circular: {
                rotateLabel: true
            },
            label: {
                normal: {
                    show: true,
                    textStyle : {
                        fontSize: 16
                    }
                }
            },
            roam: true,
            data : data,
            links: links
        }],
        animationDurationUpdate: 1500,
        animationEasingUpdate: 'quinticInOut',
    };

    return option;
}

function check() {
    if (getParamOfURL("id") == false) {
        turn('search.html');
    } else {
        showDetail(getParamOfURL("id"));
    }
}


</script>
</head>


<body onload="loadData()"> 
<!--<body onload="visual()"> -->

<div>
    <a href="http://www.duzixi.com/RC-KMS">
        <img id="logo" src="img/logo.svg"/>
        <span class ="title"> RC-KMS</span><span class="subtitle">@duzixi.com</span>
    </a>
</div>

<div id="myRadiogroup" class="yui3-widget btn-group btn-group-content">
    <button class="btn-default btn" style="color: #9e7a7a; background-color: white">关联</button>
	<button class="btn-default btn" onclick="check()">搜索</button>
	<button class="btn-default btn" onclick="turn('history.html')">排序</button>
	<button class="btn-default btn" onclick="turn('classify.html')">分类</button>
	<button class="btn-default btn" onclick="turn('heat.html')">关注度</button>
	
</div>

<div id="echart" style="width: 100%;height:80%;background-color: #f7f0f0;">(Loading ...)</div>
<div>(Data Ver.</span><span id='lastedit'></span><span>)</div>
</body>
</html>